{% extends 'base.html' %}
{% load static %}

{% block title %}Seus Dados - QuantoGastei{% endblock %}

{% block content %}
<div class="onboarding-container">
    <div class="onboarding-content">
        <div class="progress-bar">
            <div class="progress-step active"></div>
            <div class="progress-step active"></div>
            <div class="progress-step"></div>
        </div>

        <div class="onboarding-header">
            <h2>Complete seu cadastro</h2>
            <p>Preencha seus dados para come√ßar</p>
        </div>

        <div id="alert-container"></div>

        <form id="formOnboarding" class="onboarding-form">
            <div class="form-group">
                <label for="nome">Nome Completo</label>
                <input 
                    type="text" 
                    id="nome" 
                    class="form-control" 
                    placeholder="Seu nome completo"
                    required
                >
            </div>

            <div class="form-group">
                <label for="email">E-mail</label>
                <input 
                    type="email" 
                    id="email" 
                    class="form-control" 
                    placeholder="seu@email.com"
                    required
                >
                <small class="form-hint">
                    Usaremos para recuperar sua conta se necess√°rio
                </small>
            </div>

            <div class="form-group">
                <label for="telefone">Telefone (opcional)</label>
                <input 
                    type="tel" 
                    id="telefone" 
                    class="form-control" 
                    placeholder="(00) 00000-0000"
                    maxlength="15"
                >
                <small class="form-hint">
                    Para enviar lembretes de controle financeiro
                </small>
            </div>

            <div class="preferences-card">
                <h3>Prefer√™ncias</h3>
                
                <div class="toggle-container">
                    <div class="toggle-label">
                        <span class="material-symbols-outlined">notifications</span>
                        <div>
                            <div class="toggle-title">Notifica√ß√µes</div>
                            <div class="toggle-description">Lembretes para registrar gastos</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notificacoes" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="toggle-container">
                    <div class="toggle-label">
                        <span class="material-symbols-outlined">dark_mode</span>
                        <div>
                            <div class="toggle-title">Modo Escuro</div>
                            <div class="toggle-description">Apar√™ncia noturna</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="darkMode">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="voltarPasso()">
                    <span class="material-symbols-outlined">arrow_back</span>
                    Voltar
                </button>
                <button type="submit" class="btn btn-primary" id="btnSalvar">
                    Pr√≥ximo
                    <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/api.js' %}"></script>
<script>
// ===== STEP 2 - CADASTRO COMPLETO =====

// Aplicar dark mode salvo
const savedDarkMode = localStorage.getItem('darkMode') === 'true';
if (savedDarkMode) {
    document.body.classList.add('dark-mode');
    document.getElementById('darkMode').checked = true;
}

// Carregar dados do sessionStorage (veio da welcome)
document.addEventListener('DOMContentLoaded', function() {
    const tempData = sessionStorage.getItem('onboardingData');
    
    if (tempData) {
        const data = JSON.parse(tempData);
        if (data.first_name) {
            document.getElementById('nome').value = data.first_name;
        }
    }
    
    // Se veio do Google, preencher dados
    const googleName = "{{ google_name|escapejs }}";
    const googleEmail = "{{ google_email|escapejs }}";
    const jwtAccess = "{{ request.session.jwt_access|escapejs }}";
    const jwtRefresh = "{{ request.session.jwt_refresh|escapejs }}";
    
    if (googleName && googleEmail) {
        document.getElementById('nome').value = googleName;
        document.getElementById('email').value = googleEmail;
        
        if (jwtAccess && jwtRefresh) {
            localStorage.setItem('access_token', jwtAccess);
            localStorage.setItem('refresh_token', jwtRefresh);
        }
    }
});

// M√°scara de telefone
const telefoneInput = document.getElementById('telefone');
telefoneInput.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    
    if (value.length <= 11) {
        if (value.length <= 2) {
            value = value.replace(/^(\d{0,2})/, '($1');
        } else if (value.length <= 6) {
            value = value.replace(/^(\d{2})(\d{0,4})/, '($1) $2');
        } else if (value.length <= 10) {
            value = value.replace(/^(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
        } else {
            value = value.replace(/^(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
        }
    }
    
    e.target.value = value;
});

// Toggle de dark mode - ativar IMEDIATAMENTE
const darkModeToggle = document.getElementById('darkMode');
darkModeToggle.addEventListener('change', function() {
    const isDark = this.checked;
    
    if (isDark) {
        document.body.classList.add('dark-mode');
        localStorage.setItem('darkMode', 'true');
        console.log('[DARK MODE] ‚úÖ Modo escuro ATIVADO');
    } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('darkMode', 'false');
        console.log('[DARK MODE] ‚ùå Modo escuro DESATIVADO');
    }
});

// Voltar para step anterior
function voltarPasso() {
    window.location.href = '/onboarding/welcome/';
}

// Fun√ß√£o para mostrar alertas
function showAlert(message, type = 'danger') {
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = `
        <div class="alert alert-${type}" style="margin-bottom: 20px;">
            ${message}
        </div>
    `;
    
    setTimeout(() => {
        alertContainer.innerHTML = '';
    }, 5000);
}

// Fun√ß√£o para desabilitar bot√£o durante processamento
function setLoading(loading) {
    const btn = document.getElementById('btnSalvar');
    if (loading) {
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span>';
    } else {
        btn.disabled = false;
        btn.innerHTML = 'Pr√≥ximo <span class="material-symbols-outlined">arrow_forward</span>';
    }
}

// Submit do formul√°rio
document.getElementById('formOnboarding').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const nome = document.getElementById('nome').value.trim();
    const email = document.getElementById('email').value.trim();
    const telefone = document.getElementById('telefone').value.replace(/\D/g, '');
    const darkMode = document.getElementById('darkMode').checked;
    const notificacoes = document.getElementById('notificacoes').checked;
    
    // Valida√ß√µes b√°sicas
    if (!nome) {
        showAlert('Por favor, preencha seu nome completo');
        return;
    }
    
    if (!email) {
        showAlert('Por favor, preencha seu e-mail');
        return;
    }
    
    console.log('[ONBOARDING] üìù Verificando se email j√° existe...');
    setLoading(true);
    
    try {
        // Verificar se email j√° existe no sistema
        const checkResponse = await fetch(`/api/usuarios/?email=${encodeURIComponent(email)}`);
        
        if (checkResponse.ok) {
            const usuarios = await checkResponse.json();
            
            // Se encontrou usu√°rio com este email
            if (usuarios.results && usuarios.results.length > 0) {
                console.log('[ONBOARDING] ‚úÖ Email j√° cadastrado - fazendo login...');
                
                showAlert('Este e-mail j√° est√° cadastrado! Redirecionando...', 'success');
                
                // Fazer login autom√°tico (criar conta tempor√°ria se necess√°rio)
                // Na verdade, como j√° tem email, deve ir para tela de login
                setTimeout(() => {
                    window.location.href = '/login/?email=' + encodeURIComponent(email);
                }, 2000);
                
                return;
            }
        }
        
        console.log('[ONBOARDING] ‚ö†Ô∏è  Email novo - criando conta...');
        
        // Email n√£o existe - criar novo usu√°rio
        const username = email.split('@')[0] + Date.now().toString().slice(-4);
        const password = 'temp_' + Math.random().toString(36).slice(-8);
        
        const userData = {
            username: username,
            email: email,
            first_name: nome,
            password: password,
            password_confirm: password
        };
        
        const registerResponse = await fetch('/api/usuarios/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        });
        
        if (!registerResponse.ok) {
            const error = await registerResponse.json();
            console.error('[ONBOARDING] ‚ùå Erro ao criar usu√°rio:', error);
            showAlert('Erro ao criar conta. Tente novamente.');
            setLoading(false);
            return;
        }
        
        const usuario = await registerResponse.json();
        console.log('[ONBOARDING] ‚úÖ Usu√°rio criado:', usuario.id);
        
        // Fazer login com as credenciais
        const loginResponse = await fetch('/api/token/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                password: password
            })
        });
        
        if (!loginResponse.ok) {
            showAlert('Erro ao fazer login. Tente novamente.');
            setLoading(false);
            return;
        }
        
        const tokens = await loginResponse.json();
        localStorage.setItem('access_token', tokens.access);
        localStorage.setItem('refresh_token', tokens.refresh);
        
        console.log('[ONBOARDING] ‚úÖ Login realizado com sucesso!');
        
        // Salvar prefer√™ncias
        localStorage.setItem('darkMode', darkMode);
        localStorage.setItem('notificacoesAtivas', notificacoes);
        
        // Salvar telefone se fornecido
        if (telefone && telefone.length >= 10) {
            // TODO: Atualizar perfil do usu√°rio com telefone
            console.log('[ONBOARDING] üì± Telefone:', telefone);
        }
        
        showAlert('Conta criada com sucesso! Redirecionando...', 'success');
        
        // Ir para tutorial
        setTimeout(() => {
            window.location.href = '/onboarding/tutorial/';
        }, 1500);
        
    } catch (error) {
        console.error('[ONBOARDING] ‚ùå Erro:', error);
        showAlert('Erro ao processar cadastro. Tente novamente.');
        setLoading(false);
    }
});
</script>
<script src="{% static 'js/onboarding.js' %}"></script>
{% endblock %}